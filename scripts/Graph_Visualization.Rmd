---
title: "R Notebook"
output: html_notebook
---

https://kateto.net/network-visualization

```{r}
library("tidyverse")
library("igraph")

ttable <- data.frame(A = c(95, 10, 25, 19),
                     B = c(8, 50, 11, 21),
                     C = c(7, 30, 115, 7),
                     D = c(29, 29, 22, 76),
                     row.names = c("A", "B", "C", "D")) %>%
  rownames_to_column("source")

edges = ttable %>% 
  gather(key = "target", value = "weight", -source) %>%
  group_by(source) %>%
  mutate(weight = weight / sum(weight)) %>%
  select(source, target, weight)

nodes = data.frame(node_id = c("A", "B", "C", "D"),
                   cluster = c("I", "haven't", "assigned", "yet"),
                   stability = diag(as.matrix(ttable[,c(2:5)])) / rowSums(as.matrix(ttable[,c(2:5)])))

net = graph_from_data_frame(d = edges, vertices = nodes, directed = TRUE)
net = simplify(net, remove.loops = T)

colors = rainbow(4, v = .75, s = .3)
V(net)$color = colors
E(net)$width <- E(net)$weight * 40
V(net)$size <- (V(net)$stability * 100)
V(net)$label <- round(V(net)$stability, 2)
V(net)$label.font=2
E(net)$label.font=2

graph_attr(net, "layout") <- layout_with_lgl

pdf("../figures/stm_graph.pdf", height = 7, width = 7)

plot(net, 
     edge.arrow.size = 1.5,
     edge.curved = .5,
     vertex.label.family = "sans",
     edge.label.family = "sans",
     edge.label.color = "black",
     vertex.label.color = "black",
     edge.label = round(E(net)$weight, 2),
     margin = c(.5,.1,0,.1),
     edge.color = "grey70",
     main = "State Resilience and Transition Probabilities",
     cex = 1.25)

legend(x=-1.7, y=-1.5, c("State 1: E. glaucus - S.pulchra", 
                         "State 2: F. perennis - B. hordeaceous", 
                         "State 3: E. caput-medusae - A. triuncialis", 
                         "State 4: A. fatua - B. diandrus"), pch=21,
       col="#777777", 
       pt.bg=colors, pt.cex=2, cex=.8, bty="n", ncol=1)

dev.off()
```



```{r, echo = FALSE, warning = FALSE, message=FALSE}
library(lubridate); library(tidyverse); library(tidyquant)
library(msm)

clustdat <- read.csv("../data/WAPSclusters.csv",
                     header = TRUE,
                     stringsAsFactors = FALSE)

climate <- read.csv("../data/cimis_monthly.csv",
                       header = TRUE,
                       stringsAsFactors = FALSE)

climate_daily <- read.csv("../data/cimis_daily.csv",
                       header = TRUE,
                       stringsAsFactors = FALSE)

st = as.matrix(statetable.msm(cluster, plot, data = clustdat %>% arrange(plot, year)))
colnames(st) = c("Natives", "WetA", "WAPS", "DryA")
rownames(st) = c("Natives", "WetA", "WAPS", "DryA")

# Dummy vectors for priority effects
clustdat$waps = as.numeric(grepl("WAPS", clustdat$sp.trt))
clustdat$natives = as.numeric(grepl("natives", clustdat$sp.trt))
clustdat$annuals = as.numeric(grepl("annuals", clustdat$sp.trt))

# Defining initial matrix
Q <- rbind ( c(0, 0.333, 0.333, 0.333),
             c(0.333, 0, 0.333, 0.333),
             c(0.333, 0.333, 0, 0.333),
             c(0.333, 0.333, 0.333, 0))

Q.crude <- crudeinits.msm(cluster ~ year, plot, data=clustdat, qmatrix=Q)

speidata <- read.csv("../data/SPEIfits.csv")
clustdat_t0 <- clustdat %>%
   left_join((speidata %>% mutate(year = year)), by = c("year" = "year"))

msm.l1_priority <- msm(cluster ~ year, plot, data=clustdat_t0, qmatrix=Q, obstype=2,
                     covariates = list("1-2" = ~ annuals + l1fit,
                                       "1-3" = ~ waps + l1fit,
                                       "1-4" = ~ annuals + l1fit,
                                       "2-1" = ~ natives + l1fit,
                                       "2-3" = ~ waps + l1fit,
                                       "2-4" = ~ annuals + l1fit,
                                       "3-1" = ~ natives + l1fit,
                                       "3-2" = ~ annuals + l1fit,
                                       "3-4" = ~ annuals + l1fit,
                                       "4-1" = ~ natives + l1fit,
                                       "4-2" = ~ annuals + l1fit,
                                       "4-3" = ~ waps + l1fit))
```

# Assembling the dataframe that can be subsetted to produce

```{r}
planting_comp = data.frame(Planting = c("Baseline", "Natives","Naturalized","Invasive",
                                        "Native + Naturalized", "Native + Invasive", "Naturalized + Invasive",
                                        "Native + Naturalized + Invasive"),
                           Natpri = c(0,1,0,0,1,1,0,1),
                           Exopri = c(0,0,1,0,1,0,1,1),
                           Invpri = c(0,0,0,1,0,1,1,1))

edgeoutput <- list()
counter <- 1

for(netprecip in seq(-2,2, by = .25)){
  for(selected_planting in unique(planting_comp$Planting)){
    
    ttable <- matrix(pmatrix.msm(msm.l1_priority,
                             covariates=list(l1fit = netprecip,
                                             natives = planting_comp$Natpri[planting_comp$Planting == selected_planting], 
                                             annuals = planting_comp$Exopri[planting_comp$Planting == selected_planting], 
                                             waps = planting_comp$Invpri[planting_comp$Planting == selected_planting])), 
                 nrow = 4)

    rownames(ttable) = c("A", "B", "C", "D")
    colnames(ttable) = c("A", "B", "C", "D")
    
    edges = data.frame(ttable) %>% 
      rownames_to_column("source") %>%
      gather(key = "target", value = "weight", -source)
    
    edges = edges %>% mutate(Precip = netprecip,
                     Planting = selected_planting)
    
    edgeoutput[[counter]] <- edges

    counter = counter + 1
  
  }
}

write.csv("../STM_Dynamic/msmfits.csv",
          x = bind_rows(edgeoutput))

rownames(ttable) = c("A", "B", "C", "D")
colnames(ttable) = c("A", "B", "C", "D")
    
edges = data.frame(ttable) %>% 
  rownames_to_column("source") %>%
  gather(key = "target", value = "weight", -source)

edges = edges %>% mutate(Precip = netprecip,
                         Planting = selected_planting)

    
newplot <- plot_stm(edges)


ggsave(plot = newplot, 
       filename = "../figures/stm_baseline.pdf",
       height = 7, width = 8)
```

```{r}
nodes = data.frame(node_id = c("A", "B", "C", "D"),
                   cluster = c("I", "haven't", "assigned", "yet"),
                   stability = diag(ttable))

net = graph_from_data_frame(d = edges, vertices = nodes, directed = TRUE)
net = simplify(net, remove.loops = T)

colors = rainbow(4, v = .75, s = .3)
V(net)$color = colors
E(net)$width <- E(net)$weight * 40
V(net)$size <- (V(net)$stability * 100)
V(net)$label <- round(V(net)$stability, 2)
V(net)$label.font=2
E(net)$label.font=2

graph_attr(net, "layout") <- layout_with_lgl

pdf("../figures/stm_graph_modfits.pdf", height = 7, width = 7)

plot(net, 
     edge.arrow.size = 1.5,
     edge.curved = .5,
     vertex.label.family = "sans",
     edge.label.family = "sans",
     edge.label.color = "black",
     vertex.label.color = "black",
     edge.label = round(E(net)$weight, 2),
     margin = c(.5,.1,0,.1),
     edge.color = "grey70",
     main = "State Resilience and Transition Probabilities",
     cex = 1.25)

legend(x=-1.7, y=-1.5, c("State 1: E. glaucus - S.pulchra", 
                         "State 2: F. perennis - B. hordeaceous", 
                         "State 3: E. caput-medusae - A. triuncialis", 
                         "State 4: A. fatua - B. diandrus"), pch=21,
       col="#777777", 
       pt.bg=colors, pt.cex=2, cex=.8, bty="n", ncol=1)

dev.off()
```


---
title: "R Notebook"
output: html_notebook
---

# Exploring precipitation patterns

What is the best way to explore community responses to variation in precipitation patterns?

Papers on the subject seem to suggest a number of different ways to subset climate
data to make sense of changes in community composition and productivity from year
to year. 

Some relevant citations and their approaches to using climate patterns:

* Dudney et al. (2016)

Included both current-year and previous-year rainfall effects divided into Fall
(October - November), Winter (December - February), and Spring (March - May). Significant
variables were current winter, current spring, previous fall, and previous spring. Coefficients
of similar magnitudes suggest that no one season is most responsible for change. 

* Adler and Levine (2007)

Included both current-year and previous-year rainfall effects, cumulatively by year.
Also included transformations of variables to better account for nonlinearity of effects;
current and last year richness / productivity was best explained by the inverse 
transformation of current and last year precipitation.

* Pitt and Heady (1978)

Included 76(!) variables in analysis -- mean, minimum, and maximum temperatures,
number of days receiving <6.35 mm rain, total precip, days below freezing,
drough (longest successive number of days receiving <1.27 mm of rain), and
germination date (number of days after 31 first storm of 19mm).

* Eviner (2015) has a general overview:

Plant production highest in years with high and steady rainfall between November
and February, especially when temperatures are high in that period. Site-specific.

High precipitation with warm temperatures in the Fall tend to favor annual grasses,
largely due to rapid germination in warm, moist conditions.

Fall rains followed by a prolonged fall or early-winter drought tend to favor 
forbs and legumes.

Prolonged mid-winter drouhgt tends to favor forbs, clovers, and perennial grasses.

Some potential variables of interest:

* 19mm (3/4") of an inch needed for grasses to germinate

Framework for how to measure climatic variables:

1. Define the start of each year's germinating season (rainfall in 24hrs > 19mm)

2. Calculate a series of potential variables:
          * Date of season start and precip
          * Mean precip for each 30-day period following the season start
          * Total number of days without precipitation in 30-day intervals
          * Maximum number of sequential days without precipitation

```{r, echo = FALSE, warning = FALSE, message=FALSE}
library(lubridate); library(tidyverse); library(tidyquant)
library(msm)

clustdat <- read.csv("../data/WAPSclusters.csv", 
                     header = TRUE, 
                     stringsAsFactors = FALSE)

climate <- read.csv("../data/cimis_monthly.csv",
                       header = TRUE,
                       stringsAsFactors = FALSE)

climate_daily <- read.csv("../data/cimis_daily.csv",
                       header = TRUE,
                       stringsAsFactors = FALSE)

climate_daily$Date = as.POSIXct(climate_daily$Date, format = "%m/%d/%Y")

```

# First date of sufficient germinating rains

Really so late in 2012-2014?

```{r}
climate_daily %>% mutate(month = month(Date),
                         year = year(Date)) %>%
  mutate(precip_run = c(rep(0, 6), rollapply(Precip..mm., 7, sum))) %>%
  group_by(Water.Year) %>% 
  filter(precip_run > 19) %>%
  summarise(GermRain = min(Date))
```

# Total number of days in each month with no rain (or less than 1mm?)

```{r}
climate_daily %>% mutate(month = month(Date),
                         year = year(Date)) %>%
  group_by(Water.Year, month) %>%
  summarise(droughtdays = sum(na.omit(Precip..mm.) < 1)) %>%
  filter(month %in% c(11,12,1,2,3))
```

# Length of droughts in each water year

```{r}
definedrought <- function(df){
  
  counter = 1
  output <- list()  
  dstart = NA
  dend = NA

  for(i in 1:nrow(df)){
    if(df$Precip..mm.[i] < 1 & is.na(dstart)){
      dstart = df$Date[i]
    }
    
    if(df$Precip..mm.[i] > 1 & !is.na(dstart)){
      dend = df$Date[i]
      output[[counter]] = data.frame(dstart, dend, duration = dend - dstart)
      dstart = NA
      dend = NA
      counter <- counter + 1
    }
  }
  
  return(bind_rows(output))
  
}

climate_daily = climate_daily[!is.na(climate_daily$Precip..mm.),]

droughtsummary = climate_daily %>% 
  mutate(month = month(Date),
         year = year(Date)) %>% 
  arrange(Date) %>%
  group_by(Water.Year) %>%
  filter(month %in% c(11,12,1,2,3,4)) %>%
  do(definedrought(.)) %>%
  mutate(duration = round(duration))

droughtsummary %>% 
  ggplot(aes(x = duration)) +
  geom_histogram()

cat("Longest Observed Winter Droughts:")
droughtsummary %>%
  group_by(Water.Year) %>%
  filter(duration == max(duration))
```



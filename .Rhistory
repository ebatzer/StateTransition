library(lubridate); library(tidyverse); library(tidyquant)
library(msm)
clustdat <- read.csv("../data/WAPSclusters.csv",
header = TRUE,
stringsAsFactors = FALSE)
climate <- read.csv("../data/cimis_monthly.csv",
header = TRUE,
stringsAsFactors = FALSE)
climate_daily <- read.csv("../data/cimis_daily.csv",
header = TRUE,
stringsAsFactors = FALSE)
st = as.matrix(statetable.msm(cluster, plot, data = clustdat %>% arrange(plot, year)))
colnames(st) = c("Natives", "WetA", "WAPS", "DryA")
rownames(st) = c("Natives", "WetA", "WAPS", "DryA")
st
# Dummy vectors for priority effects
clustdat$waps = as.numeric(grepl("WAPS", clustdat$sp.trt))
clustdat$natives = as.numeric(grepl("natives", clustdat$sp.trt))
clustdat$annuals = as.numeric(grepl("annuals", clustdat$sp.trt))
# Defining initial matrix
Q <- rbind ( c(0, 0.333, 0.333, 0.333),
c(0.333, 0, 0.333, 0.333),
c(0.333, 0.333, 0, 0.333),
c(0.333, 0.333, 0.333, 0))
Q.crude <- crudeinits.msm(cluster ~ year, plot, data=clustdat, qmatrix=Q)
# Base model
msm.null <- msm(cluster ~ year, plot, data=clustdat, qmatrix=Q, obstype=2)
# With priority effects
msm.priority <- msm(cluster ~ year, plot, data=clustdat, qmatrix=Q, obstype=2,
covariates = list("1-2" = ~ annuals,
"1-3" = ~ waps,
"1-4" = ~ annuals,
"2-1" = ~ natives,
"2-3" = ~ waps,
"2-4" = ~ annuals,
"3-1" = ~ natives,
"3-2" = ~ annuals,
"3-4" = ~ annuals,
"4-1" = ~ natives,
"4-2" = ~ annuals,
"4-3" = ~ waps))
cat("Likelihood ratio test: \n")
lrtest.msm(msm.null, msm.priority)
plot.prevalence.msm(msm.priority, mintime=2008, maxtime=2018)
cat("1 - Native, 2 - Priority Annuals, 3 - WAPS, 4 - Dry Annuals")
climate_daily$Date = as.POSIXct(climate_daily$Date, format = "%m/%d/%Y")
climate_daily %>%
group_by(month=floor_date(Date, "month")) %>%
summarise(precip = sum(na.omit(Precip..mm.)),
eto = sum(na.omit(ETo..mm.))) %>%
ggplot(aes(x = month, y = precip)) +
geom_line() +
xlab("Date (Aggregated by Month)") +
ylab("Total Precip (mm)") +
ggtitle("Precipitation by Month 2006 - 2018")
climate_daily %>%
group_by(month=floor_date(Date, "month")) %>%
summarise(precip = sum(na.omit(Precip..mm.)),
eto = sum(na.omit(ETo..mm.))) %>%
ggplot(aes(x = month, y = precip - eto)) +
geom_line()+
xlab("Date (Aggregated by Month)") +
ylab("Precip - ETo (mm)") +
ggtitle("Net Water Deficit by Month 2006 - 2018")
climate_daily %>% mutate(month = month(Date),
year = year(Date)) %>%
group_by(Water.Year) %>%
filter(month %in% c(11,12,1,2)) %>%
summarise(precip = sum(na.omit(Precip..mm.)),
eto = sum(ETo..mm.)) %>%
ggplot() +
geom_bar(stat = "identity",
aes(y = precip,
x = Water.Year,
fill = "blue"),
width = .3, color = "black") +
geom_bar(stat = "identity",
aes(y = eto,
x = Water.Year + .3,
fill = "tan"),
width = .3, color = "black") +
geom_bar(stat = "identity",
aes(y = precip - eto,
x = Water.Year + .6,
fill = "green"),
width = .3, color = "black") +
geom_ma(aes(y = precip - eto,
x = Water.Year + .6),
color = "black", n = 3) +
scale_fill_identity(name = 'Measure', guide = 'legend', labels = c('Precip (mm)', 'ETo (mm)', 'Net (mm)')) +
xlab("Year") +
ylab("Water Availability (Nov - Feb") +
ggtitle("CIMIS Early Season Water Availability")
climate$month = gsub("-.*", "", climate$Month.Year)
climsum = climate_daily %>% mutate(month = month(Date), year = year(Date)) %>%
group_by(Water.Year) %>%
filter(month %in% c(11,12,1,2)) %>%
summarise(precip = sum(na.omit(Precip..mm.)),
eto = sum(ETo..mm.),
net = precip - eto) %>%
mutate(threeyear_ma = SMA(net, 3),
net_cum_2 = c(NA, rollsum(net, 2)),
net_cum_3 = c(NA, NA, rollsum(net, 3)))
# Adding weather data
clustdat = left_join(clustdat, climsum %>% rename(year = Water.Year))
# With environmental covariates
msm.env <- msm(cluster ~ year, plot, data=clustdat, qmatrix=Q, obstype=2, covariates = ~ net_cum_3)
msm.env_priority <- msm(cluster ~ year, plot, data=clustdat, qmatrix=Q, obstype=2,
covariates = list("1-2" = ~ annuals + net_cum_3,
"1-3" = ~ waps + net_cum_3,
"1-4" = ~ annuals + net_cum_3,
"2-1" = ~ natives + net_cum_3,
"2-3" = ~ waps + net_cum_3,
"2-4" = ~ annuals + net_cum_3,
"3-1" = ~ natives + net_cum_3,
"3-2" = ~ annuals + net_cum_3,
"3-4" = ~ annuals + net_cum_3,
"4-1" = ~ natives + net_cum_3,
"4-2" = ~ annuals + net_cum_3,
"4-3" = ~ waps + net_cum_3))
cat("Likelihood ratio test (with env. covariates vs. null): \n")
lrtest.msm(msm.null, msm.env)
cat("Likelihood ratio test (with env. covariates + priority vs. priority: \n")
lrtest.msm(msm.priority, msm.env)
cat("AIC scores of all models (lowest score is best): \n")
data.frame(model = c("Null", "Priority", "Environment", "Env + Priority"),
AIC = c(AIC(msm.null), AIC(msm.priority), AIC(msm.env), AIC(msm.env_priority)))
# Estimated values of Q
qmat = as.matrix(qmatrix.msm(msm.env_priority)$estimates)
colnames(qmat) = c("Natives", "WetA", "WAPS", "DryA")
rownames(qmat) = c("Natives", "WetA", "WAPS", "DryA")
# With both
# plot.prevalence.msm(msm.l1_priority, mintime=2008, maxtime=2018)
# cat("1 - Native, 2 - Priority Annuals, 3 - WAPS, 4 - Dry Annuals")
speidata <- read.csv("../data/SPEIfits.csv")
colnames(speidata)
clustdat_t1 <- clustdat %>%
left_join((speidata %>% mutate(year = year + 1)), by = c("year" = "year"))
msm.l1_priority <- msm(cluster ~ year, plot, data=clustdat_t1, qmatrix=Q, obstype=2,
covariates = list("1-2" = ~ annuals + l1fit,
"1-3" = ~ waps + l1fit,
"1-4" = ~ annuals + l1fit,
"2-1" = ~ natives + l1fit,
"2-3" = ~ waps + l1fit,
"2-4" = ~ annuals + l1fit,
"3-1" = ~ natives + l1fit,
"3-2" = ~ annuals + l1fit,
"3-4" = ~ annuals + l1fit,
"4-1" = ~ natives + l1fit,
"4-2" = ~ annuals + l1fit,
"4-3" = ~ waps + l1fit))
msm.l2_priority <- msm(cluster ~ year, plot, data=clustdat_t1, qmatrix=Q, obstype=2,
covariates = list("1-2" = ~ annuals + l2fit,
"1-3" = ~ waps + l2fit,
"1-4" = ~ annuals + l2fit,
"2-1" = ~ natives + l2fit,
"2-3" = ~ waps + l2fit,
"2-4" = ~ annuals + l2fit,
"3-1" = ~ natives + l2fit,
"3-2" = ~ annuals + l2fit,
"3-4" = ~ annuals + l2fit,
"4-1" = ~ natives + l2fit,
"4-2" = ~ annuals + l2fit,
"4-3" = ~ waps + l2fit))
msm.l3_priority <- msm(cluster ~ year, plot, data=clustdat_t1, qmatrix=Q, obstype=2,
covariates = list("1-2" = ~ annuals + l3fit,
"1-3" = ~ waps + l3fit,
"1-4" = ~ annuals + l3fit,
"2-1" = ~ natives + l3fit,
"2-3" = ~ waps + l3fit,
"2-4" = ~ annuals + l3fit,
"3-1" = ~ natives + l3fit,
"3-2" = ~ annuals + l3fit,
"3-4" = ~ annuals + l3fit,
"4-1" = ~ natives + l3fit,
"4-2" = ~ annuals + l3fit,
"4-3" = ~ waps + l3fit))
cat("T1 Model")
AIC(msm.env_priority, msm.l1_priority, msm.l2_priority, msm.l3_priority)
clustdat_t0 <- clustdat %>%
left_join((speidata %>% mutate(year = year)), by = c("year" = "year"))
msm.l1_priority <- msm(cluster ~ year, plot, data=clustdat_t0, qmatrix=Q, obstype=2,
covariates = list("1-2" = ~ annuals + l1fit,
"1-3" = ~ waps + l1fit,
"1-4" = ~ annuals + l1fit,
"2-1" = ~ natives + l1fit,
"2-3" = ~ waps + l1fit,
"2-4" = ~ annuals + l1fit,
"3-1" = ~ natives + l1fit,
"3-2" = ~ annuals + l1fit,
"3-4" = ~ annuals + l1fit,
"4-1" = ~ natives + l1fit,
"4-2" = ~ annuals + l1fit,
"4-3" = ~ waps + l1fit))
msm.l2_priority <- msm(cluster ~ year, plot, data=clustdat_t0, qmatrix=Q, obstype=2,
covariates = list("1-2" = ~ annuals + l2fit,
"1-3" = ~ waps + l2fit,
"1-4" = ~ annuals + l2fit,
"2-1" = ~ natives + l2fit,
"2-3" = ~ waps + l2fit,
"2-4" = ~ annuals + l2fit,
"3-1" = ~ natives + l2fit,
"3-2" = ~ annuals + l2fit,
"3-4" = ~ annuals + l2fit,
"4-1" = ~ natives + l2fit,
"4-2" = ~ annuals + l2fit,
"4-3" = ~ waps + l2fit))
msm.l3_priority <- msm(cluster ~ year, plot, data=clustdat_t0, qmatrix=Q, obstype=2,
covariates = list("1-2" = ~ annuals + l3fit,
"1-3" = ~ waps + l3fit,
"1-4" = ~ annuals + l3fit,
"2-1" = ~ natives + l3fit,
"2-3" = ~ waps + l3fit,
"2-4" = ~ annuals + l3fit,
"3-1" = ~ natives + l3fit,
"3-2" = ~ annuals + l3fit,
"3-4" = ~ annuals + l3fit,
"4-1" = ~ natives + l3fit,
"4-2" = ~ annuals + l3fit,
"4-3" = ~ waps + l3fit))
cat("T0 Model")
AIC(msm.l1_priority, msm.l2_priority, msm.l3_priority)
qmatrix.msm(msm.l1_priority, covariates=list(l1fit = 0))
p12 = 1 - exp(-.02581)
p13 = 1 - exp(-.02605)
p14 = 1 - exp(-.1894)
tot = sum(p12,p13,p14)
p12/tot
p13/tot
p14/tot
Nprob = list()
counter = 1
for(pri in c(0:1)){
for(netprecip in seq(-1.5, 1.5, by = .1)){
qm = as.matrix(qmatrix.msm(msm.l1_priority, covariates=list(l1fit = netprecip,
natives = pri, annuals = pri, waps = pri))$estimates)
ql = as.matrix(qmatrix.msm(msm.l1_priority, covariates=list(l1fit = netprecip,
natives = pri, annuals = pri, waps = pri))$L)
qu = as.matrix(qmatrix.msm(msm.l1_priority, covariates=list(l1fit = netprecip,
natives = pri, annuals = pri, waps = pri))$U)
qdf = data.frame(qm) %>% mutate(From = rownames(qm)) %>%
gather("key" = "To", "value" = "Trans", -From) %>%
mutate(To = gsub("\\.", " ", To))
qlow = data.frame(ql) %>% mutate(From = rownames(ql)) %>%
gather("key" = "To", "value" = "Lower", -From) %>%
mutate(To = gsub("\\.", " ", To))
qupp = data.frame(qu) %>% mutate(From = rownames(qu)) %>%
gather("key" = "To", "value" = "Upper", -From) %>%
mutate(To = gsub("\\.", " ", To))
qdf$Trans = if_else(qdf$From == qdf$To, exp(qdf$Trans), 1 - exp(-qdf$Trans))
qlow$Lower = if_else(qlow$From == qlow$To, exp(qlow$Lower), 1 - exp(-qlow$Lower))
qupp$Upper = if_else(qupp$From == qupp$To, exp(qupp$Upper), 1 - exp(-qupp$Upper))
output <- left_join(qdf, qlow) %>% left_join(qupp)
output$precip = rep(netprecip, nrow(output))
output$priority = rep(pri, nrow(output))
Nprob[[counter]] <- output
counter = counter + 1
}
}
library(viridis)
cols = rainbow(4, v = .5)
bind_rows(Nprob) %>%
filter(From == To) %>%
mutate(priority = if_else(priority == 1, "In Mixture", "Alone")) %>%
ggplot(aes(x = precip,
color = From,
fill = From)) +
geom_line(aes(y = Trans), size = 1.5) +
theme_bw() +
#geom_ribbon(aes(ymax = Upper, ymin = Lower), alpha = .2) +
facet_wrap(~priority) +
ggtitle("Climate and Seeding Composition Effects on State Resilience") +
scale_color_manual(name = 'State Assignment',
values =c("State 1" = cols[1],
"State 2" = cols[2],
"State 3" = cols[3],
"State 4" = cols[4]),
labels = c('E. glaucus - S. pulchra',
'F. perennis - B. hordeaceous',
'E. caput-medusae - A. triuncialis',
'A. fatua - B. diandrus')) +
scale_fill_manual(name = 'State Assignment',
values =c("State 1" = cols[1], "State 2" = cols[2],
"State 3" = cols[3], "State 4" = cols[4]),
labels = c('E. glaucus - S. pulchra',
'F. perennis - B. hordeaceous',
'E. caput-medusae - A. triuncialis',
'A. fatua - B. diandrus')) +
xlab("SPEI") +
ylab("Probability of Retaining State in Next Year")
# ggsave("../figures/StabilityProbabilities_NoErrorBars.pdf", height = 4, width = 7)
trtnames = c("to Natives", "to Priority Annuals", "to WAPS", "to Dry Annuals")
priorities = c("No Priority", "Priority")
tprob = function(stateval = "State 1", title = "E. glaucus - S. pulchra"){
p = bind_rows(Nprob)
p$Trans[p$From == stateval & p$To == stateval] = -1
plot = p %>%
# filter(From != To) %>%
filter(To == stateval) %>%
mutate(priority = if_else(priority == 1, "Represented In Seeding", "Not Represented")) %>%
ggplot(aes(x = precip,
color = From,
fill = From)) +
geom_line(aes(y = Trans), size = 1.5) +
theme_bw() +
#geom_ribbon(aes(ymax = Upper, ymin = Lower), alpha = .2) +
facet_grid(~priority) +
ggtitle(title) +
scale_color_manual(name = 'Previous State Assignment',
values =c("State 1" = cols[1], "State 2" = cols[2],
"State 3" = cols[3], "State 4" = cols[4]),
labels = c('E. glaucus - S. pulchra',
'F. perennis - B. hordeaceous',
'E. caput-medusae - A. triuncialis',
'A. fatua - B. diandrus')) +
scale_fill_manual(name = 'Initial State',
values =c("State 1" = cols[1], "State 2" = cols[2],
"State 3" = cols[3], "State 4" = cols[4]),
labels = c('E. glaucus - S. pulchra',
'F. perennis - B. hordeaceous',
'E. caput-medusae - A. triuncialis',
'A. fatua - B. diandrus')) +
xlab("SPEI") +
ylab("Probability of Assignment in Next Year") +
ylim(0, .5)
return(plot)
}
alltogether = gridExtra::grid.arrange(tprob(),
tprob("State 2", 'F. perennis - B. hordeaceous'),
tprob("State 3", 'E. caput-medusae - A. triuncialis'),
tprob("State 4", 'A. fatua - B. diandrus'),
nrow = 4,
ncol = 1,
top = "Probability of Transition to States")
# ggsave(plot = alltogether,
#        "../figures/TransitionProbabilities_NoErrorBars_v2.pdf", height = 14, width = 8)
stateval = "State 1"
title = "E. glaucus - S. pulchra"
textdf = data.frame(
precip = c(0,0),
Trans = c(.5, .5),
lab = c("+ Priority", "- Priority"),
priority = c("E. glaucus - S. pulchra ", "E. glaucus - S. pulchra"))
p = bind_rows(Nprob)
# p$Trans[p$From == stateval & p$To == stateval] = -1
plot = p %>%
filter(From != To) %>%
filter(To == stateval) %>%
mutate(To = plyr::revalue(To,
c("State 1" = 'E. glaucus - S. pulchra',
"State 2" = 'F. perennis - B. hordeaceous',
"State 3" = 'E. caput-medusae - A. triuncialis',
"State 4" = 'A. fatua - B. diandrus'))) %>%
mutate(priority = if_else(priority == 1, "E. glaucus - S. pulchra ", "E. glaucus - S. pulchra")) %>%
ggplot(aes(x = precip,
color = From,
fill = From)) +
geom_line(aes(y = Trans), size = 1.5) +
theme_bw() +
#geom_ribbon(aes(ymax = Upper, ymin = Lower), alpha = .2) +
facet_grid(~priority) +
ggtitle("Seeding Composition Effects on Transition Probability") +
scale_color_manual(name = 'Previous State Assignment',
values =c("State 2" = cols[2],
"State 3" = cols[3], "State 4" = cols[4]),
labels = c('F. perennis - B. hordeaceous',
'E. caput-medusae - A. triuncialis',
'A. fatua - B. diandrus')) +
scale_fill_manual(name = 'Initial State',
values =c("State 2" = cols[2],
"State 3" = cols[3], "State 4" = cols[4]),
labels = c('F. perennis - B. hordeaceous',
'E. caput-medusae - A. triuncialis',
'A. fatua - B. diandrus')) +
xlab("SPEI") +
ylab("Probability of Assignment in Next Year") +
ylim(0, .5) +
geom_text(data = textdf, aes(fill = NULL, color = NULL, y= Trans), label = textdf$lab, show.legend = FALSE)
# plot
# ggsave("../figures/eglaspul_transition.pdf", width = 7, height = 4)
stateval = c("State 3", "State 4")
p = bind_rows(Nprob)
# p$Trans[p$From == stateval & p$To == stateval] = -1
plot = p %>%
group_by(From, To, precip) %>%
summarise(Trans = mean(Trans)) %>%
filter(From != To) %>%
filter(To == stateval) %>%
ungroup() %>%
mutate(To = plyr::revalue(To,
c("State 1" = 'E. glaucus - S. pulchra',
"State 2" = 'F. perennis - B. hordeaceous',
"State 3" = 'E. caput-medusae - A. triuncialis',
"State 4" = 'A. fatua - B. diandrus'))) %>%
# mutate(priority = if_else(priority == 1, "Represented In Seeding", "Not Represented")) %>%
ggplot(aes(x = precip,
color = From,
fill = From)) +
geom_line(aes(y = Trans), size = 1.5) +
theme_bw() +
#geom_ribbon(aes(ymax = Upper, ymin = Lower), alpha = .2) +
facet_grid(~To) +
ggtitle("Climate Effects on Transition Probability") +
scale_color_manual(name = 'Previous State Assignment',
values =c("State 1" = cols[1], "State 2" = cols[2],
"State 3" = cols[3], "State 4" = cols[4]),
labels = c('E. glaucus - S. pulchra',
'F. perennis - B. hordeaceous',
'E. caput-medusae - A. triuncialis',
'A. fatua - B. diandrus')) +
scale_fill_manual(name = 'Initial State',
values =c("State 1" = cols[1], "State 2" = cols[2],
"State 3" = cols[3], "State 4" = cols[4]),
labels = c('E. glaucus - S. pulchra',
'F. perennis - B. hordeaceous',
'E. caput-medusae - A. triuncialis',
'A. fatua - B. diandrus')) +
xlab("SPEI") +
ylab("Probability of Assignment in Next Year") +
ylim(0, .5)
# ggsave("../figures/climate_transition.pdf", width = 7, height = 4)
pearson.msm(msm.l1_priority)
